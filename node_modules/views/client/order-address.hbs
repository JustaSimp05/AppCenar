<div class="row mt-4">
  <div class="col-md-7">
    <h2>Selecciona una dirección</h2>
    <hr>

    {{#unless addresses.length}}
      <div class="alert alert-warning">
        No tienes direcciones. Debes crear al menos una en "Mis direcciones" para continuar.
      </div>
      <a href="/client/addresses" class="btn btn-primary">Ir a mis direcciones</a>
    {{/unless}}

    {{#if addresses.length}}
      <form id="orderAddressForm">
        {{#each addresses}}
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="addressId" id="addr-{{_id}}" value="{{_id}}">
            <label class="form-check-label" for="addr-{{_id}}">
              <strong>{{nombre}}</strong> - {{descripcion}}
            </label>
          </div>
        {{/each}}

        <button type="submit" class="btn btn-success mt-3">Pedir</button>
        <a href="/client/catalog/{{commerce._id}}" class="btn btn-secondary mt-3 ms-2">Volver al catálogo</a>
      </form>
    {{/if}}
  </div>

  <div class="col-md-5">
    <h4>Resumen del pedido</h4>
    <div class="card">
      <div class="card-body">
        {{#if commerce.logoComercio}}
          <img src="{{commerce.logoComercio}}" class="img-fluid mb-2" style="max-height: 80px; object-fit: contain;">
        {{/if}}
        <h5>{{commerce.nombreComercio}}</h5>

        <hr>
        <p>Subtotal: <strong>RD$ {{subtotal}}</strong></p>
        <p>ITBIS ({{itbis}}%): <strong>RD$ {{../itbis}}</strong></p>
        <p>Total: <strong>RD$ {{total}}</strong></p>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('orderAddressForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const addressId = formData.get('addressId');

  if (!addressId) {
    alert('Selecciona una dirección');
    return;
  }

  const res = await fetch('/client/order/create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ addressId })
  });

  const data = await res.json();
  if (data.success) {
    window.location.href = data.redirect || '/client/home';
  } else {
    alert(data.error || 'Error al crear pedido');
  }
});
</script>
