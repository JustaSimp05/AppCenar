<div class="container mt-4">
  <!-- Encabezado comercio -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center">

          {{#if commerce.logoComercio}}
          <img src="{{commerce.logoComercio}}" class="rounded-circle me-3"
               style="width: 64px; height: 64px; object-fit: cover;">
          {{/if}}

          <div>
            <h2 class="mb-1">{{commerce.nombreComercio}}</h2>
            <p class="text-muted mb-0">
              <i class="fas fa-tag me-1"></i>{{commerce.tipoComercio.nombre}}
            </p>
            <small class="text-muted d-block">
              <i class="fas fa-clock me-1"></i>
              {{commerce.horaApertura}} - {{commerce.horaCierre}}
            </small>
            <small class="text-muted d-block">
              <i class="fas fa-phone me-1"></i>{{commerce.telefono}}
            </small>
          </div>
        </div>

        <div class="text-end">
          <a href="/client/commerces/{{commerce.tipoComercio._id}}"
             class="btn btn-outline-secondary mb-2">
            <i class="fas fa-arrow-left me-1"></i>Volver a comercios
          </a>

          <br>

          <!-- FIX: usar commerce._id y data-commerce (consistente con JS) -->
          <button class="btn btn-outline-danger btn-sm toggle-favorito"
                  data-commerce="{{commerce._id}}"
                  data-action="{{#if (includes favoritosSet commerce._id)}}remove{{else}}add{{/if}}">

            {{#if (includes favoritosSet commerce._id)}}
              <i class="fas fa-heart"></i> Remover
            {{else}}
              <i class="far fa-heart"></i> Favorito
            {{/if}}

          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row">

    <!-- Catálogo -->
    <div class="col-lg-9">
      <div id="contenedorProductos">

        {{#each categories}}
        <div class="mb-5">
          <div class="d-flex align-items-center mb-3">
            <h4 class="mb-0">{{this.nombre}}</h4>
            {{#if this.descripcion}}
            <small class="text-muted ms-2">{{this.descripcion}}</small>
            {{/if}}
          </div>

          <div class="row">

            {{#if this.products.length}}
              {{#each this.products}}

              <div class="col-md-4 col-sm-6 mb-4">
                <div class="card h-100 shadow-sm">

                  {{#if this.foto}}
                  <img src="{{this.foto}}" class="card-img-top"
                       style="height: 200px; object-fit: cover;">
                  {{else}}
                  <div class="bg-light d-flex align-items-center justify-content-center"
                       style="height: 200px;">
                    <i class="fas fa-utensils fa-4x text-muted"></i>
                  </div>
                  {{/if}}

                  <div class="card-body d-flex flex-column">
                    <h6 class="card-title">{{this.nombre}}</h6>
                    <p class="card-text small text-muted flex-grow-1">{{this.descripcion}}</p>

                    <div class="d-flex justify-content-between align-items-center mt-auto">
                      <span class="h5 text-success mb-0">RD${{this.precio}}</span>

                      <button class="btn btn-success btn-sm agregar-carrito"
                              data-producto="{{this._id}}">
                        <i class="fas fa-plus me-1"></i>Agregar
                      </button>
                    </div>
                  </div>

                </div>
              </div>

              {{/each}}
            {{else}}
              <div class="col-12">
                <p class="text-muted">No hay productos en esta categoría.</p>
              </div>
            {{/if}}

          </div>
        </div>
        {{/each}}

      </div>
    </div>
    <!-- Carrito lateral -->
    <div class="col-lg-3">
      <div class="card sticky-top" style="top: 20px;">

        <div class="card-header bg-success text-white">
          <h6 class="mb-0">
            <i class="fas fa-shopping-cart me-2"></i>Mi Pedido
          </h6>
          <small class="d-block">
            ({{#if carrito}}{{carrito.length}}{{else}}0{{/if}} productos)
          </small>
        </div>

        <div class="card-body p-0">
          <div id="contenedorCarrito">

            {{#if carrito}}
              {{#each carrito}}

              <div class="producto-carrito p-3 border-bottom" data-producto="{{this.productId}}">
                <div class="d-flex justify-content-between align-items-start">

                  <div class="flex-grow-1 me-2">
                    <h6 class="mb-1">{{this.name}}</h6>
                    <small class="text-muted">RD${{this.price}} c/u</small>
                  </div>

                  <div class="text-end">

                    <!-- Controles de cantidad -->
                    <div class="input-group input-group-sm" style="max-width: 150px;">
                      <button class="btn btn-outline-secondary decrementar"
                              data-producto="{{this.productId}}">
                        -
                      </button>

                      <input type="text" class="form-control text-center cantidad"
                             value="{{this.quantity}}" readonly>

                      <button class="btn btn-outline-secondary incrementar"
                              data-producto="{{this.productId}}">
                        +
                      </button>
                    </div>

                    <!-- Total del item -->
                    <div class="mt-1">
                      <small class="fw-bold text-success">
                        RD$ {{multiply this.price this.quantity}}
                      </small>
                    </div>

                    <!-- Botón eliminar -->
                    <button class="btn btn-sm btn-outline-danger remover-carrito mt-2"
                            data-producto="{{this.productId}}"
                            style="width: 100%; font-size: 13px;">
                      <i class="fas fa-trash me-1"></i>Eliminar
                    </button>

                  </div>

                </div>
              </div>

              {{/each}}
            {{else}}

              <div class="p-3 text-center text-muted">
                <i class="fas fa-shopping-cart fa-3x mb-3 opacity-50"></i>
                <p>Tu carrito está vacío</p>
                <small>Agrega productos del menú</small>
              </div>

            {{/if}}

          </div>

          {{#if carrito}}
          <!-- Pie del carrito -->
          <div class="p-3 border-top bg-light">

            <div class="d-flex justify-content-between mb-2">
              <span>Subtotal:</span>
              <span class="h6 mb-0" id="subtotal">RD$ {{subtotal}}</span>
            </div>

            <button id="btnContinuar" class="btn btn-success w-100">
              <i class="fas fa-truck me-2"></i>
              Continuar al Pedido
            </button>

          </div>
          {{else}}

          <div class="p-3 text-center">
            <small class="text-muted">No hay productos seleccionados</small>
          </div>

          {{/if}}

        </div>

      </div>
    </div>

  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {

  const comercioId = '{{commerce._id}}';

  document.addEventListener('click', async (e) => {

    // AGREGAR PRODUCTO
    if (e.target.closest('.agregar-carrito')) {
      const btn = e.target.closest('.agregar-carrito');
      const productId = btn.dataset.producto;

      btn.disabled = true;
      try {
        await fetch('/client/cart', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'add', productId, quantity: 1 })
        });
        location.reload();
      } catch (err) {
        alert('Error al agregar producto');
      }
      btn.disabled = false;
    }

      // RESTAR -1
      if (e.target.closest('.decrementar')) {
        const id = e.target.closest('.decrementar').dataset.producto;
        actualizarCarrito('decrement', id, 1);
      }

      // SUMAR +1
      if (e.target.closest('.incrementar')) {
        const id = e.target.closest('.incrementar').dataset.producto;
        actualizarCarrito('increment', id, 1);
      }

    // ELIMINAR TODO
    if (e.target.closest('.remover-carrito')) {
      const id = e.target.closest('.remover-carrito').dataset.producto;
      if (confirm("¿Eliminar este producto del carrito?")) {
        actualizarCarrito('remove', id, 0);
      }
    }

    // CONTINUAR
    if (e.target.closest('#btnContinuar')) {
      window.location.href = "/client/order/address";
    }

    // FAVORITO
    if (e.target.closest('.toggle-favorito')) {
      const btn = e.target.closest('.toggle-favorito');

      // tomar correctamente el id y la acción
      const action = btn.dataset.action;
      const commerceId = btn.dataset.commerce || comercioId; // si por alguna razón no tiene, usar comercioId de la página

      // validación ligera antes de enviar
      if (!commerceId) {
        alert('Error al procesar favorito (commerceId faltante).');
        return;
      }

      try {
        const res = await fetch("/client/favorites", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ commerceId, action })
        });

        // parsear respuesta UNA vez
        const data = await res.json();

        if (!res.ok || !data.success) {
          // mostrar mensaje útil si viene del backend
          alert(data.message || 'Error al procesar favorito');
          return;
        }

        // Toggle visual: actualizar texto e ícono y el data-action
        if (action === "add" || action === "Add" || action === "added") {
          btn.innerHTML = '<i class="fas fa-heart"></i> Remover';
          btn.dataset.action = "remove";
        } else {
          btn.innerHTML = '<i class="far fa-heart"></i> Favorito';
          btn.dataset.action = "add";
        }

      } catch (err) {
        console.error('Error fetch favorito:', err);
        alert('Error al procesar favorito');
      }
    }

  });

  async function actualizarCarrito(action, productId, quantity) {
    try {
      await fetch('/client/cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, productId, quantity })
      });
      location.reload();
    } catch (err) {
      alert("Error al actualizar carrito");
    }
  }

});
</script>
