<div class="container py-4">
  
  <div class="card border-0 shadow-sm mb-5 overflow-hidden">
    <div class="card-body p-4 p-lg-5">
      <div class="row align-items-center">
        <div class="col-md-8 d-flex align-items-center">
          
          {{!-- Logo --}}
          <div class="position-relative me-4">
            {{#if commerce.logoComercio}}
              <img src="{{commerce.logoComercio}}" class="rounded-circle border border-4 border-white shadow-sm" style="width: 80px; height: 80px; object-fit: cover;">
            {{else}}
              <div class="rounded-circle bg-light d-flex align-items-center justify-content-center border border-4 border-white shadow-sm" style="width: 80px; height: 80px;">
                <i class="fas fa-store fa-2x text-muted"></i>
              </div>
            {{/if}}
          </div>

          {{!-- Info Texto --}}
          <div>
            <h1 class="fw-bold mb-1 text-dark">{{commerce.nombreComercio}}</h1>
            <div class="d-flex flex-wrap gap-3 text-muted small">
              <span class="badge bg-light text-dark border"><i class="fas fa-tag me-1"></i>{{commerce.tipoComercio.nombre}}</span>
              <span><i class="far fa-clock me-1"></i> {{commerce.horaApertura}} - {{commerce.horaCierre}}</span>
              <span><i class="fas fa-phone-alt me-1"></i> {{commerce.telefono}}</span>
            </div>
          </div>
        </div>

        {{!-- Botones de Acción --}}
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <a href="/client/commerces/{{commerce.tipoComercio._id}}" class="btn btn-outline-secondary btn-sm rounded-pill mb-2 mb-md-0 me-2">
            <i class="fas fa-arrow-left me-1"></i> Volver
          </a>

          <button class="btn btn-outline-danger btn-sm rounded-pill toggle-favorito shadow-sm"
                  data-commerce="{{commerce._id}}"
                  data-action="{{#if (includes favoritosSet commerce._id)}}remove{{else}}add{{/if}}">
            {{#if (includes favoritosSet commerce._id)}}
              <i class="fas fa-heart me-1"></i> Remover
            {{else}}
              <i class="far fa-heart me-1"></i> Favorito
            {{/if}}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">

    <div class="col-lg-8">
      <div id="contenedorProductos">

        {{#each categories}}
        <div class="mb-5">
          
          {{!-- Título Categoría --}}
          <div class="d-flex align-items-end mb-4 border-bottom pb-2">
            <h4 class="fw-bold text-dark mb-0 border-start border-4 border-primary ps-3">{{this.nombre}}</h4>
            {{#if this.descripcion}}
              <small class="text-muted ms-3 mb-1">{{this.descripcion}}</small>
            {{/if}}
          </div>

          <div class="row g-3">
            {{#if this.products.length}}
              {{#each this.products}}
              <div class="col-md-6">
                <div class="card h-100 border-0 shadow-sm hover-effect">
                  <div class="row g-0 h-100">
                    
                    {{!-- Imagen del Producto --}}
                    <div class="col-4">
                      {{#if this.foto}}
                        <img src="{{this.foto}}" class="img-fluid rounded-start h-100 w-100" style="object-fit: cover; min-height: 140px;">
                      {{else}}
                        <div class="bg-light d-flex align-items-center justify-content-center h-100 text-muted" style="min-height: 140px;">
                          <i class="fas fa-utensils fa-2x opacity-50"></i>
                        </div>
                      {{/if}}
                    </div>

                    {{!-- Cuerpo del Producto --}}
                    <div class="col-8">
                      <div class="card-body d-flex flex-column h-100 p-3">
                        <h6 class="card-title fw-bold text-dark mb-1">{{this.nombre}}</h6>
                        <p class="card-text small text-muted mb-2 flex-grow-1" style="line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                          {{this.descripcion}}
                        </p>

                        <div class="d-flex justify-content-between align-items-end mt-2">
                          <span class="fw-bold text-primary">RD$ {{this.precio}}</span>
                          <button class="btn btn-sm btn-primary rounded-circle shadow-sm agregar-carrito" 
                                  data-producto="{{this._id}}" 
                                  style="width: 32px; height: 32px; padding: 0;">
                            <i class="fas fa-plus"></i>
                          </button>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
              {{/each}}
            {{else}}
              <div class="col-12">
                <div class="alert alert-light text-center text-muted">No hay productos disponibles en esta categoría.</div>
              </div>
            {{/if}}
          </div>
        </div>
        {{/each}}

        {{!-- Productos sin categoría --}}
        {{#if productsWithoutCategory.length}}
        <div class="mb-5">
          <h4 class="fw-bold text-dark mb-0 border-start border-4 border-primary ps-3 mb-4">Otros</h4>
          <div class="row g-3">
            {{#each productsWithoutCategory}}
              <div class="col-md-6">
                <div class="card h-100 border-0 shadow-sm hover-effect">
                  <div class="row g-0 h-100">
                    <div class="col-4">
                      {{#if this.foto}}
                        <img src="{{this.foto}}" class="img-fluid rounded-start h-100 w-100" style="object-fit: cover; min-height: 140px;">
                      {{else}}
                        <div class="bg-light d-flex align-items-center justify-content-center h-100 text-muted" style="min-height: 140px;">
                          <i class="fas fa-utensils fa-2x opacity-50"></i>
                        </div>
                      {{/if}}
                    </div>
                    <div class="col-8">
                      <div class="card-body d-flex flex-column h-100 p-3">
                        <h6 class="card-title fw-bold text-dark mb-1">{{this.nombre}}</h6>
                        <p class="card-text small text-muted mb-2 flex-grow-1" style="line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                          {{this.descripcion}}
                        </p>
                        <div class="d-flex justify-content-between align-items-end mt-2">
                          <span class="fw-bold text-primary">RD$ {{this.precio}}</span>
                          <button class="btn btn-sm btn-primary rounded-circle shadow-sm agregar-carrito" 
                                  data-producto="{{this._id}}" 
                                  style="width: 32px; height: 32px; padding: 0;">
                            <i class="fas fa-plus"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            {{/each}}
          </div>
        </div>
        {{/if}}

      </div>
    </div>

    <div class="col-lg-4">
      
      <div class="card border-0 shadow" 
           style="position: sticky; top: 100px; z-index: 100; max-height: calc(100vh - 120px); display: flex; flex-direction: column; border-radius: 16px;">
        
        <div class="card-header bg-white border-bottom py-3 flex-shrink-0">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold"><i class="fas fa-shopping-basket text-primary me-2"></i>Tu Pedido</h5>
            <span class="badge bg-primary rounded-pill">{{#if carrito}}{{carrito.length}}{{else}}0{{/if}}</span>
          </div>
        </div>

        <div class="card-body p-0" style="overflow-y: auto; flex-grow: 1;">
          <div id="contenedorCarrito">

            {{#if carrito}}
              <ul class="list-group list-group-flush">
              {{#each carrito}}
              <li class="list-group-item p-3 border-bottom-0 border-top">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <h6 class="mb-0 fw-bold text-dark small">{{this.name}}</h6>
                    <small class="text-muted">RD$ {{this.price}} c/u</small>
                  </div>
                  <div class="text-end">
                    <small class="fw-bold text-primary">RD$ {{multiply this.price this.quantity}}</small>
                  </div>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                  <div class="input-group input-group-sm" style="width: 90px;">
                    <button class="btn btn-outline-secondary decrementar" data-producto="{{this.productId}}" type="button"><i class="fas fa-minus" style="font-size: 0.7rem;"></i></button>
                    <input type="text" class="form-control text-center border-secondary bg-white px-0" value="{{this.quantity}}" readonly>
                    <button class="btn btn-outline-secondary incrementar" data-producto="{{this.productId}}" type="button"><i class="fas fa-plus" style="font-size: 0.7rem;"></i></button>
                  </div>

                  <button class="btn btn-link text-danger btn-sm p-0 remover-carrito" data-producto="{{this.productId}}" title="Eliminar">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </li>
              {{/each}}
              </ul>
            {{else}}
              <div class="text-center py-5">
                <i class="fas fa-shopping-basket fa-3x text-muted opacity-25 mb-3"></i>
                <p class="text-muted mb-0 fw-medium">Tu carrito está vacío</p>
                <small class="text-muted">¡Agrega algo delicioso!</small>
              </div>
            {{/if}}

          </div>
        </div>

        {{#if carrito}}
        <div class="card-footer bg-white border-top p-3 flex-shrink-0">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Subtotal estimado</span>
            <span class="h5 mb-0 fw-bold text-dark" id="subtotal">RD$ {{subtotal}}</span>
          </div>
          <button id="btnContinuar" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">
            Continuar al Pedido <i class="fas fa-arrow-right ms-2"></i>
          </button>
        </div>
        {{/if}}

      </div>
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const comercioId = '{{commerce._id}}';

  document.addEventListener('click', async (e) => {

    // AGREGAR PRODUCTO
    if (e.target.closest('.agregar-carrito')) {
      const btn = e.target.closest('.agregar-carrito');
      const productId = btn.dataset.producto;

      btn.disabled = true;
      try {
        await fetch('/client/cart', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'add', productId, quantity: 1 })
        });
        location.reload();
      } catch (err) {
        alert('Error al agregar producto');
      }
      btn.disabled = false;
    }

      // RESTAR -1
      if (e.target.closest('.decrementar')) {
        const id = e.target.closest('.decrementar').dataset.producto;
        actualizarCarrito('decrement', id, 1);
      }

      // SUMAR +1
      if (e.target.closest('.incrementar')) {
        const id = e.target.closest('.incrementar').dataset.producto;
        actualizarCarrito('increment', id, 1);
      }

    // ELIMINAR TODO
    if (e.target.closest('.remover-carrito')) {
      const id = e.target.closest('.remover-carrito').dataset.producto;
      if (confirm("¿Eliminar este producto del carrito?")) {
        actualizarCarrito('remove', id, 0);
      }
    }

    // CONTINUAR
    if (e.target.closest('#btnContinuar')) {
      window.location.href = "/client/order/address";
    }

    // FAVORITO
    if (e.target.closest('.toggle-favorito')) {
      const btn = e.target.closest('.toggle-favorito');

      // tomar correctamente el id y la acción
      const action = btn.dataset.action;
      const commerceId = btn.dataset.commerce || comercioId; 

      if (!commerceId) {
        alert('Error al procesar favorito (commerceId faltante).');
        return;
      }

      try {
        const res = await fetch("/client/favorites", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ commerceId, action })
        });

        const data = await res.json();

        if (!res.ok || !data.success) {
          alert(data.message || 'Error al procesar favorito');
          return;
        }

        // Toggle visual
        if (action === "add" || action === "Add" || action === "added") {
          btn.innerHTML = '<i class="fas fa-heart me-1"></i> Remover';
          btn.dataset.action = "remove";
        } else {
          btn.innerHTML = '<i class="far fa-heart me-1"></i> Favorito';
          btn.dataset.action = "add";
        }

      } catch (err) {
        console.error('Error fetch favorito:', err);
        alert('Error al procesar favorito');
      }
    }

  });

  async function actualizarCarrito(action, productId, quantity) {
    try {
      await fetch('/client/cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, productId, quantity })
      });
      location.reload();
    } catch (err) {
      alert("Error al actualizar carrito");
    }
  }

});
</script>